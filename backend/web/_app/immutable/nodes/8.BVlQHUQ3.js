import{t as Zt}from"../chunks/Bvp1Wu3z.js";import{e as te}from"../chunks/DNSHY1Ls.js";import"../chunks/NZTpNUN0.js";import{a as K,o as ee,c as ae,s as q}from"../chunks/Cw6sL175.js";import{p as W,f as m,c as $,n as Q,r as k,a as o,b as F,k as re,m as oe,u as se,l as ht,s as g,e as x,C as p,B as I,t as J,g as l,d as O,h as Dt}from"../chunks/hUgNfGIw.js";import{p as X,r as Y,b as Z,i as St}from"../chunks/297qlWCs.js";import{a as ne}from"../chunks/C8ON3q3r.js";import{c as v}from"../chunks/BGAF9F00.js";import{c as tt,B as mt}from"../chunks/Hn86ru-6.js";import{C as le,B as de,a as ie}from"../chunks/IsgJQnF1.js";import{C as ce}from"../chunks/Ch7_jghy.js";import{C as ue,a as fe}from"../chunks/bulbDurL.js";import{a as et}from"../chunks/emurSIzu.js";import{g as ve}from"../chunks/I6_ffaLo.js";import{G as he}from"../chunks/Bv0ASKdf.js";import{P as me}from"../chunks/Dwt4ZveH.js";import{R as ge}from"../chunks/BIHNfLOA.js";import{f as _e,j as pe}from"../chunks/C74-udT0.js";const $e=!1,ke=async({url:h})=>{const t=Number(h.searchParams.get("page"))||1,n=Number(h.searchParams.get("limit"))||20,s=h.searchParams.get("sort")||"createdAt",r=h.searchParams.get("order")||"desc";try{typeof window<"u"&&(console.log("Client-side load function executing"),console.log("Current URL:",window.location.href));const i=await Zt.list({page:t,limit:n,sort:s,order:r});return{tasks:i.data,pagination:i.pagination}}catch(i){console.error("Failed to load tasks:",i),i instanceof Error&&console.error("Error details:",{message:i.message,stack:i.stack}),te(500,"タスクの読み込みに失敗しました")}},sa=Object.freeze(Object.defineProperty({__proto__:null,load:ke,prerender:$e},Symbol.toStringTag,{value:"Module"}));var be=m('<div data-slot="table-container" class="relative w-full overflow-x-auto"><table><!></table></div>');function we(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=be(),i=$(r);et(i,G=>({"data-slot":"table",class:G,...s}),[()=>tt("w-full caption-bottom text-sm",t.class)]);var u=$(i);K(u,()=>t.children??Q),k(i),Z(i,G=>n(G),()=>n()),k(r),o(h,r),F()}var xe=m("<tbody><!></tbody>");function ye(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=xe();et(r,u=>({"data-slot":"table-body",class:u,...s}),[()=>tt("[&_tr:last-child]:border-0",t.class)]);var i=$(r);K(i,()=>t.children??Q),k(r),Z(r,u=>n(u),()=>n()),o(h,r),F()}var Pe=m("<td><!></td>");function lt(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=Pe();et(r,u=>({"data-slot":"table-cell",class:u,...s}),[()=>tt("whitespace-nowrap bg-clip-padding p-2 align-middle [&:has([role=checkbox])]:pr-0",t.class)]);var i=$(r);K(i,()=>t.children??Q),k(r),Z(r,u=>n(u),()=>n()),o(h,r),F()}var Ie=m("<th><!></th>");function gt(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=Ie();et(r,u=>({"data-slot":"table-head",class:u,...s}),[()=>tt("text-foreground h-10 whitespace-nowrap bg-clip-padding px-2 text-left align-middle font-medium [&:has([role=checkbox])]:pr-0",t.class)]);var i=$(r);K(i,()=>t.children??Q),k(r),Z(r,u=>n(u),()=>n()),o(h,r),F()}var Te=m("<thead><!></thead>");function Ce(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=Te();et(r,u=>({"data-slot":"table-header",class:u,...s}),[()=>tt("[&_tr]:border-b",t.class)]);var i=$(r);K(i,()=>t.children??Q),k(r),Z(r,u=>n(u),()=>n()),o(h,r),F()}var Ae=m("<tr><!></tr>");function jt(h,t){W(t,!0);let n=X(t,"ref",15,null),s=Y(t,["$$slots","$$events","$$legacy","ref","class","children"]);var r=Ae();et(r,u=>({"data-slot":"table-row",class:u,...s}),[()=>tt("hover:[&,&>svelte-css-wrapper]:[&>th,td]:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",t.class)]);var i=$(r);K(i,()=>t.children??Q),k(r),Z(r,u=>n(u),()=>n()),o(h,r),F()}var De=m("<!> ツリー表示",1),Se=m("<!> 新しいタスク",1),je=m("<!> <!>",1),Ee=m("<!> <!> <!> <!>",1),Be=m('<div class="flex items-center gap-1 text-xs text-muted-foreground"><!> <span>継続タスク</span></div>'),Me=m('<div class="space-y-1"><p class="truncate"> </p> <!></div>'),Ne=m("<!> <!> <!> <!>",1),Re=m("<!> <!>",1),Ue=m("<!> <!>",1),Le=m('<div class="flex justify-center gap-2"><!> <div class="flex items-center px-4"> </div> <!></div>'),Oe=m('<div class="space-y-6"><div class="flex justify-between items-center"><div><h2 class="text-3xl font-bold tracking-tight">タスク一覧</h2> <p class="text-muted-foreground">実行中のタスクを管理</p></div> <div class="flex gap-2"><!> <!></div></div> <!> <!></div>');function na(h,t){W(t,!0);const n=ve();let s=re(oe(t.data.tasks||[]));se(()=>{ht(s,t.data.tasks||[],!0)});function r(e){const a=e.detail;switch(console.log("[タスク一覧] WebSocketメッセージ受信:",{type:a.type,taskId:a.taskId,data:a.data,currentTaskCount:l(s).length}),a.type){case"task:update":console.log("[タスク一覧] タスク更新:",a),i(a);break;case"task:status":case"task:running":console.log("[タスク一覧] タスク状態を更新（旧形式）:",a),G(a);break;case"task:completed":case"task:failed":case"task:cancelled":console.log("[タスク一覧] タスク完了/失敗/キャンセル（旧形式）:",a),G(a);break;default:console.log("[タスク一覧] 未処理のメッセージタイプ:",a.type)}}function i(e){const d=e.taskId||e.data?.taskId||e.payload?.taskId,a=e.data||e.payload||{},f=a.status;if(console.log("[タスク一覧] handleTaskUpdate:",{messageTaskId:e.taskId,dataTaskId:e.data?.taskId,payloadTaskId:e.payload?.taskId,finalTaskId:d,status:f}),!d){console.warn("[タスク一覧] タスクIDが見つかりません:",e);return}const c=l(s).findIndex(_=>_.taskId===d);if(c>=0){const _={...l(s)[c]};f&&(_.status=f);const b=a.metadata||e.data?.metadata||{};b.completedAt&&(_.completedAt=b.completedAt),b.duration&&(_.duration=b.duration),b.error&&(_.error=b.error),b.workingDirectory&&(_.workingDirectory=b.workingDirectory),_.updatedAt=e.timestamp||a.timestamp||new Date().toISOString(),ht(s,[...l(s).slice(0,c),_,...l(s).slice(c+1)],!0),console.log("[タスク一覧] タスクを更新:",_)}else(f==="pending"||f==="running")&&(console.log("[タスク一覧] 新しいタスクを検出、APIから詳細を取得:",d),u(d))}async function u(e){try{const d=await fetch(`http://localhost:5000/api/tasks/${e}`,{headers:{"Content-Type":"application/json"}});if(d.ok){const a=await d.json();if(!l(s).some(c=>c.taskId===e)){const c={...a,id:a.id||a.taskId};ht(s,[c,...l(s)],!0),console.log("[タスク一覧] 新しいタスクを追加:",c)}}}catch(d){console.error("[タスク一覧] タスク詳細の取得に失敗:",d)}}function G(e){const d=e.taskId||e.data?.taskId||e.payload?.taskId,a=e.data||e.payload||e;if(!d)return;const f=l(s).findIndex(c=>c.taskId===d);if(f!==-1){const c={...l(s)[f]};a.status&&(c.status=a.status),a.updatedAt&&(c.updatedAt=a.updatedAt),a.completedAt&&(c.completedAt=a.completedAt),a.duration&&(c.duration=a.duration),a.error&&(c.error=a.error),ht(s,[...l(s).slice(0,f),c,...l(s).slice(f+1)],!0),console.log("[タスク一覧] タスクを更新:",c)}}function Et(){console.log("[タスク一覧] すべてのタスクをサブスクライブ"),n.subscribe("*")}ee(()=>{if(window.addEventListener("websocket:message",r),n.connected||n.connect(),n.connected&&n.authenticated)Et();else{const e=setInterval(()=>{n.connected&&n.authenticated&&(Et(),clearInterval(e))},100);setTimeout(()=>clearInterval(e),5e3)}}),ae(()=>{window.removeEventListener("websocket:message",r)});function Lt(e){switch(e){case"completed":return"default";case"running":return"secondary";case"failed":return"destructive";case"cancelled":return"outline";default:return"secondary"}}function Ot(e){return e?_e(new Date(e),"yyyy/MM/dd HH:mm",{locale:pe}):"-"}function Wt(e){if(!e)return"-";const d=e.split("/");return d[d.length-1]||"-"}function Ft(e){window.location.href=`/tasks/${e}`}function Gt(){window.location.href="/tasks/new"}var _t=Oe(),pt=$(_t),Bt=g($(pt),2),Mt=$(Bt);mt(Mt,{variant:"outline",onclick:()=>window.location.href="/tasks/tree",children:(e,d)=>{var a=De(),f=x(a);he(f,{class:"mr-2 h-4 w-4"}),p(),o(e,a)},$$slots:{default:!0}});var Ht=g(Mt,2);mt(Ht,{onclick:Gt,children:(e,d)=>{var a=Se(),f=x(a);me(f,{class:"mr-2 h-4 w-4"}),p(),o(e,a)},$$slots:{default:!0}}),k(Bt),k(pt);var Nt=g(pt,2);v(Nt,()=>ie,(e,d)=>{d(e,{children:(a,f)=>{var c=Ue(),_=x(c);v(_,()=>ue,(E,at)=>{at(E,{children:(B,qt)=>{var rt=je(),dt=x(rt);v(dt,()=>fe,(ot,st)=>{st(ot,{children:(it,ct)=>{p();var M=I("実行中のタスク");o(it,M)},$$slots:{default:!0}})});var $t=g(dt,2);v($t,()=>ce,(ot,st)=>{st(ot,{children:(it,ct)=>{p();var M=I();J(()=>q(M,`${l(s).length??""} 件のタスク`)),o(it,M)},$$slots:{default:!0}})}),o(B,rt)},$$slots:{default:!0}})});var b=g(_,2);v(b,()=>le,(E,at)=>{at(E,{children:(B,qt)=>{var rt=O(),dt=x(rt);v(dt,()=>we,($t,ot)=>{ot($t,{children:(st,it)=>{var ct=Re(),M=x(ct);v(M,()=>Ce,(kt,bt)=>{bt(kt,{children:(wt,Kt)=>{var nt=O(),xt=x(nt);v(xt,()=>jt,(yt,Pt)=>{Pt(yt,{children:(S,H)=>{var z=Ee(),j=x(z);v(j,()=>gt,(y,T)=>{T(y,{children:(C,V)=>{p();var P=I("ステータス");o(C,P)},$$slots:{default:!0}})});var w=g(j,2);v(w,()=>gt,(y,T)=>{T(y,{children:(C,V)=>{p();var P=I("リポジトリ");o(C,P)},$$slots:{default:!0}})});var N=g(w,2);v(N,()=>gt,(y,T)=>{T(y,{children:(C,V)=>{p();var P=I("指示内容");o(C,P)},$$slots:{default:!0}})});var ut=g(N,2);v(ut,()=>gt,(y,T)=>{T(y,{children:(C,V)=>{p();var P=I("作成日時");o(C,P)},$$slots:{default:!0}})}),o(S,z)},$$slots:{default:!0}})}),o(wt,nt)},$$slots:{default:!0}})});var Jt=g(M,2);v(Jt,()=>ye,(kt,bt)=>{bt(kt,{children:(wt,Kt)=>{var nt=O(),xt=x(nt);{var yt=S=>{var H=O(),z=x(H);ne(z,17,()=>l(s),j=>j.taskId,(j,w)=>{var N=O(),ut=x(N);v(ut,()=>jt,(y,T)=>{T(y,{class:"cursor-pointer hover:bg-muted/50 transition-colors",onclick:()=>Ft(l(w).taskId),children:(C,V)=>{var P=Ne(),It=x(P);v(It,()=>lt,(R,U)=>{U(R,{children:(L,Tt)=>{{let A=Dt(()=>Lt(l(w).status));de(L,{get variant(){return l(A)},children:(D,Ut)=>{p();var vt=I();J(()=>q(vt,l(w).status)),o(D,vt)},$$slots:{default:!0}})}},$$slots:{default:!0}})});var ft=g(It,2);v(ft,()=>lt,(R,U)=>{U(R,{class:"text-sm",children:(L,Tt)=>{p();var A=I();J(D=>q(A,D),[()=>Wt(l(w).context?.workingDirectory||l(w).workingDirectory)]),o(L,A)},$$slots:{default:!0}})});var Rt=g(ft,2);v(Rt,()=>lt,(R,U)=>{U(R,{class:"max-w-md",children:(L,Tt)=>{var A=Me(),D=$(A),Ut=$(D,!0);k(D);var vt=g(D,2);{var Xt=Ct=>{var At=Be(),Yt=$(At);ge(Yt,{class:"h-3 w-3"}),p(2),k(At),o(Ct,At)};St(vt,Ct=>{(l(w).continuedFrom||l(w).parentTaskId)&&Ct(Xt)})}k(A),J(()=>q(Ut,l(w).instruction)),o(L,A)},$$slots:{default:!0}})});var Qt=g(Rt,2);v(Qt,()=>lt,(R,U)=>{U(R,{children:(L,Tt)=>{p();var A=I();J(D=>q(A,D),[()=>Ot(l(w).createdAt)]),o(L,A)},$$slots:{default:!0}})}),o(C,P)},$$slots:{default:!0}})}),o(j,N)}),o(S,H)},Pt=S=>{var H=O(),z=x(H);v(z,()=>jt,(j,w)=>{w(j,{children:(N,ut)=>{var y=O(),T=x(y);v(T,()=>lt,(C,V)=>{V(C,{colspan:4,class:"text-center text-muted-foreground",children:(P,It)=>{p();var ft=I("タスクがありません");o(P,ft)},$$slots:{default:!0}})}),o(N,y)},$$slots:{default:!0}})}),o(S,H)};St(xt,S=>{l(s)&&l(s).length>0?S(yt):S(Pt,!1)})}o(wt,nt)},$$slots:{default:!0}})}),o(st,ct)},$$slots:{default:!0}})}),o(B,rt)},$$slots:{default:!0}})}),o(a,c)},$$slots:{default:!0}})});var zt=g(Nt,2);{var Vt=e=>{var d=Le(),a=$(d);{let b=Dt(()=>t.data.pagination.page<=1);mt(a,{variant:"outline",get disabled(){return l(b)},onclick:()=>window.location.href=`/tasks?page=${t.data.pagination.page-1}`,children:(E,at)=>{p();var B=I("前へ");o(E,B)},$$slots:{default:!0}})}var f=g(a,2),c=$(f);k(f);var _=g(f,2);{let b=Dt(()=>t.data.pagination.page>=t.data.pagination.totalPages);mt(_,{variant:"outline",get disabled(){return l(b)},onclick:()=>window.location.href=`/tasks?page=${t.data.pagination.page+1}`,children:(E,at)=>{p();var B=I("次へ");o(E,B)},$$slots:{default:!0}})}k(d),J(()=>q(c,`ページ ${t.data.pagination.page??""} / ${t.data.pagination.totalPages??""}`)),o(e,d)};St(zt,e=>{t.data.pagination&&t.data.pagination.totalPages>1&&e(Vt)})}k(_t),o(h,_t),F()}export{na as component,sa as universal};
