import{t as $t}from"../chunks/8-ECe_Y2.js";import{e as pt}from"../chunks/DNSHY1Ls.js";import"../chunks/NZTpNUN0.js";import{a as Q,s as q,o as xt,c as Tt}from"../chunks/DMzQSiFV.js";import{p as A,f as u,c as g,n as X,r as m,a as n,b as L,d as U,e as v,C as k,B as T,t as K,g as B,h as lt,s as h,k as kt,m as yt,l as gt,u as It}from"../chunks/CibTsHxy.js";import{c as Y,B as ct}from"../chunks/BkNxBhzy.js";import{p as Z,r as tt,b as et,i as bt}from"../chunks/D2tfWl3j.js";import{a as St}from"../chunks/BBRwJ9cY.js";import{c}from"../chunks/Dmq7Nx9n.js";import{B as Ct,C as At,a as Lt}from"../chunks/Bvs5g0ah.js";import{C as Dt}from"../chunks/DP_CO7Qi.js";import{C as jt,a as Et}from"../chunks/CeXjzowc.js";import{a as at}from"../chunks/BR09V1wi.js";import{R as Ht}from"../chunks/CVkBE2Ak.js";import{g as Ut}from"../chunks/B4NzQXt4.js";import{G as Bt}from"../chunks/BPKQsP3q.js";import{P as Nt}from"../chunks/D_hoom7v.js";const Rt=!1,Wt=async({url:i})=>{const t=Number(i.searchParams.get("page"))||1,r=Number(i.searchParams.get("limit"))||20,s=i.searchParams.get("sort")||"createdAt",a=i.searchParams.get("order")||"desc";try{typeof window<"u"&&(console.log("Client-side load function executing"),console.log("Current URL:",window.location.href));const e=await $t.list({page:t,limit:r,sort:s,order:a});return{tasks:e.data,pagination:e.pagination}}catch(e){console.error("Failed to load tasks:",e),e instanceof Error&&console.error("Error details:",{message:e.message,stack:e.stack}),pt(500,"タスクの読み込みに失敗しました")}},Ce=Object.freeze(Object.defineProperty({__proto__:null,load:Wt,prerender:Rt},Symbol.toStringTag,{value:"Module"}));var zt=u('<div data-slot="table-container" class="relative w-full overflow-x-auto"><table><!></table></div>');function Ot(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=zt(),e=g(a);at(e,l=>({"data-slot":"table",class:l,...s}),[()=>Y("w-full caption-bottom text-sm",t.class)]);var o=g(e);Q(o,()=>t.children??X),m(e),et(e,l=>r(l),()=>r()),m(a),n(i,a),L()}var Ft=u("<tbody><!></tbody>");function Gt(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=Ft();at(a,o=>({"data-slot":"table-body",class:o,...s}),[()=>Y("[&_tr:last-child]:border-0",t.class)]);var e=g(a);Q(e,()=>t.children??X),m(a),et(a,o=>r(o),()=>r()),n(i,a),L()}var Mt=u("<td><!></td>");function nt(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=Mt();at(a,o=>({"data-slot":"table-cell",class:o,...s}),[()=>Y("whitespace-nowrap bg-clip-padding p-2 align-middle [&:has([role=checkbox])]:pr-0",t.class)]);var e=g(a);Q(e,()=>t.children??X),m(a),et(a,o=>r(o),()=>r()),n(i,a),L()}var Jt=u("<th><!></th>");function dt(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=Jt();at(a,o=>({"data-slot":"table-head",class:o,...s}),[()=>Y("text-foreground h-10 whitespace-nowrap bg-clip-padding px-2 text-left align-middle font-medium [&:has([role=checkbox])]:pr-0",t.class)]);var e=g(a);Q(e,()=>t.children??X),m(a),et(a,o=>r(o),()=>r()),n(i,a),L()}var Vt=u("<thead><!></thead>");function qt(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=Vt();at(a,o=>({"data-slot":"table-header",class:o,...s}),[()=>Y("[&_tr]:border-b",t.class)]);var e=g(a);Q(e,()=>t.children??X),m(a),et(a,o=>r(o),()=>r()),n(i,a),L()}var Kt=u("<tr><!></tr>");function _t(i,t){A(t,!0);let r=Z(t,"ref",15,null),s=tt(t,["$$slots","$$events","$$legacy","ref","class","children"]);var a=Kt();at(a,o=>({"data-slot":"table-row",class:o,...s}),[()=>Y("hover:[&,&>svelte-css-wrapper]:[&>th,td]:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",t.class)]);var e=g(a);Q(e,()=>t.children??X),m(a),et(a,o=>r(o),()=>r()),n(i,a),L()}var Qt=u('<div class="flex items-center gap-1 text-xs text-muted-foreground"><!> <span>継続タスク</span></div>'),Xt=u('<div class="space-y-1"><p class="truncate"> </p> <!></div>'),Yt=u("<!> <!> <!> <!>",1);function Zt(i,t){A(t,!0);function r(l){switch(l){case"completed":return"default";case"running":return"secondary";case"failed":return"destructive";case"cancelled":return"outline";default:return"secondary"}}function s(l){if(!l)return"-";const _=l.split("/");return _[_.length-1]||"-"}function a(l){return l?new Date(l).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}var e=U(),o=v(e);c(o,()=>_t,(l,_)=>{_(l,{class:"cursor-pointer hover:bg-muted/50 transition-colors",onclick:()=>t.onClick(t.task.taskId),children:(N,z)=>{var $=Yt(),d=v($);c(d,()=>nt,(x,I)=>{I(x,{children:(P,D)=>{{let f=lt(()=>r(t.task.status));Ct(P,{get variant(){return B(f)},children:(w,S)=>{k();var G=T();K(()=>q(G,t.task.status)),n(w,G)},$$slots:{default:!0}})}},$$slots:{default:!0}})});var p=h(d,2);c(p,()=>nt,(x,I)=>{I(x,{class:"text-sm",children:(P,D)=>{k();var f=T();K(w=>q(f,w),[()=>s(t.task.context?.workingDirectory||t.task.workingDirectory)]),n(P,f)},$$slots:{default:!0}})});var b=h(p,2);c(b,()=>nt,(x,I)=>{I(x,{class:"max-w-md",children:(P,D)=>{var f=Xt(),w=g(f),S=g(w,!0);m(w);var G=h(w,2);{var st=O=>{var F=Qt(),ut=g(F);Ht(ut,{class:"h-3 w-3"}),k(2),m(F),n(O,F)};bt(G,O=>{(t.task.continuedFrom||t.task.parentTaskId)&&O(st)})}m(f),K(()=>q(S,t.task.instruction)),n(P,f)},$$slots:{default:!0}})});var y=h(b,2);c(y,()=>nt,(x,I)=>{I(x,{children:(P,D)=>{k();var f=T();K(w=>q(f,w),[()=>a(t.task.createdAt)]),n(P,f)},$$slots:{default:!0}})}),n(N,$)},$$slots:{default:!0}})}),n(i,e),L()}var te=u("<!> <!>",1),ee=u("<!> <!> <!> <!>",1),ae=u("<!> <!>",1),se=u("<!> <!>",1);function re(i,t){A(t,!0);var r=U(),s=v(r);c(s,()=>Lt,(a,e)=>{e(a,{children:(o,l)=>{var _=se(),N=v(_);c(N,()=>jt,($,d)=>{d($,{children:(p,b)=>{var y=te(),x=v(y);c(x,()=>Et,(P,D)=>{D(P,{children:(f,w)=>{k();var S=T("実行中のタスク");n(f,S)},$$slots:{default:!0}})});var I=h(x,2);c(I,()=>Dt,(P,D)=>{D(P,{children:(f,w)=>{k();var S=T();K(()=>q(S,`${t.tasks.length??""} 件のタスク`)),n(f,S)},$$slots:{default:!0}})}),n(p,y)},$$slots:{default:!0}})});var z=h(N,2);c(z,()=>At,($,d)=>{d($,{children:(p,b)=>{var y=U(),x=v(y);c(x,()=>Ot,(I,P)=>{P(I,{children:(D,f)=>{var w=ae(),S=v(w);c(S,()=>qt,(st,O)=>{O(st,{children:(F,ut)=>{var rt=U(),ft=v(rt);c(ft,()=>_t,(vt,ht)=>{ht(vt,{children:(R,M)=>{var J=ee(),W=v(J);c(W,()=>dt,(C,j)=>{j(C,{children:(E,ot)=>{k();var H=T("ステータス");n(E,H)},$$slots:{default:!0}})});var V=h(W,2);c(V,()=>dt,(C,j)=>{j(C,{children:(E,ot)=>{k();var H=T("リポジトリ");n(E,H)},$$slots:{default:!0}})});var it=h(V,2);c(it,()=>dt,(C,j)=>{j(C,{children:(E,ot)=>{k();var H=T("指示内容");n(E,H)},$$slots:{default:!0}})});var wt=h(it,2);c(wt,()=>dt,(C,j)=>{j(C,{children:(E,ot)=>{k();var H=T("作成日時");n(E,H)},$$slots:{default:!0}})}),n(R,J)},$$slots:{default:!0}})}),n(F,rt)},$$slots:{default:!0}})});var G=h(S,2);c(G,()=>Gt,(st,O)=>{O(st,{children:(F,ut)=>{var rt=U(),ft=v(rt);{var vt=R=>{var M=U(),J=v(M);St(J,17,()=>t.tasks,W=>W.taskId,(W,V)=>{Zt(W,{get task(){return B(V)},get onClick(){return t.onTaskClick}})}),n(R,M)},ht=R=>{var M=U(),J=v(M);c(J,()=>_t,(W,V)=>{V(W,{children:(it,wt)=>{var C=U(),j=v(C);c(j,()=>nt,(E,ot)=>{ot(E,{colspan:4,class:"text-center text-muted-foreground",children:(H,ue)=>{k();var Pt=T("タスクがありません");n(H,Pt)},$$slots:{default:!0}})}),n(it,C)},$$slots:{default:!0}})}),n(R,M)};bt(ft,R=>{t.tasks&&t.tasks.length>0?R(vt):R(ht,!1)})}n(F,rt)},$$slots:{default:!0}})}),n(D,w)},$$slots:{default:!0}})}),n(p,y)},$$slots:{default:!0}})}),n(o,_)},$$slots:{default:!0}})}),n(i,r),L()}var oe=u('<div class="flex justify-center gap-2"><!> <div class="flex items-center px-4"> </div> <!></div>');function ne(i,t){A(t,!0);var r=U(),s=v(r);{var a=e=>{var o=oe(),l=g(o);{let $=lt(()=>t.currentPage<=1);ct(l,{variant:"outline",get disabled(){return B($)},onclick:()=>t.onPageChange(t.currentPage-1),children:(d,p)=>{k();var b=T("前へ");n(d,b)},$$slots:{default:!0}})}var _=h(l,2),N=g(_);m(_);var z=h(_,2);{let $=lt(()=>t.currentPage>=t.totalPages);ct(z,{variant:"outline",get disabled(){return B($)},onclick:()=>t.onPageChange(t.currentPage+1),children:(d,p)=>{k();var b=T("次へ");n(d,b)},$$slots:{default:!0}})}m(o),K(()=>q(N,`ページ ${t.currentPage??""} / ${t.totalPages??""}`)),n(e,o)};bt(s,e=>{t.totalPages>1&&e(a)})}n(i,r),L()}class le{#t=kt(yt([]));get tasks(){return B(this.#t)}set tasks(t){gt(this.#t,t,!0)}#e=kt(!1);get loading(){return B(this.#e)}set loading(t){gt(this.#e,t,!0)}#a=kt(null);get error(){return B(this.#a)}set error(t){gt(this.#a,t,!0)}ws=null;messageHandler=null;initialize(t,r){this.tasks=t||[],this.ws=r,this.setupWebSocket()}cleanup(){this.messageHandler&&(window.removeEventListener("websocket:message",this.messageHandler),this.messageHandler=null)}setupWebSocket(){if(this.messageHandler=t=>{const s=t.detail;switch(console.log("[TaskListStore] WebSocketメッセージ受信:",{type:s.type,taskId:s.taskId,data:s.data}),s.type){case"task:update":this.handleTaskUpdate(s);break;case"task:status":case"task:running":this.handleTaskStatusUpdate(s);break;case"task:completed":case"task:failed":case"task:cancelled":this.handleTaskStatusUpdate(s);break}},window.addEventListener("websocket:message",this.messageHandler),!!this.ws)if(this.ws.connected||this.ws.connect(),this.ws.connected&&this.ws.authenticated)this.subscribeToAllTasks();else{const t=setInterval(()=>{this.ws&&this.ws.connected&&this.ws.authenticated&&(this.subscribeToAllTasks(),clearInterval(t))},100);setTimeout(()=>clearInterval(t),5e3)}}subscribeToAllTasks(){console.log("[TaskListStore] すべてのタスクをサブスクライブ"),this.ws&&this.ws.subscribe("*")}handleTaskUpdate(t){const r=t.taskId||t.data?.taskId||t.payload?.taskId,s=t.data||t.payload||{},a=s.status;if(!r){console.warn("[TaskListStore] タスクIDが見つかりません:",t);return}const e=this.tasks.findIndex(o=>o.taskId===r);if(e>=0){const o={...this.tasks[e]};a&&(o.status=a);const l=s.metadata||t.data?.metadata||{};l.completedAt&&(o.completedAt=l.completedAt),l.duration&&(o.duration=l.duration),l.error&&(o.error=l.error),l.workingDirectory&&(o.workingDirectory=l.workingDirectory),o.updatedAt=t.timestamp||s.timestamp||new Date().toISOString(),this.tasks=[...this.tasks.slice(0,e),o,...this.tasks.slice(e+1)],console.log("[TaskListStore] タスクを更新:",o)}else(a==="pending"||a==="running")&&(console.log("[TaskListStore] 新しいタスクを検出、APIから詳細を取得:",r),this.fetchTaskDetails(r))}handleTaskStatusUpdate(t){const r=t.taskId||t.data?.taskId||t.payload?.taskId,s=t.data||t.payload||t;if(!r)return;const a=this.tasks.findIndex(e=>e.taskId===r);if(a!==-1){const e={...this.tasks[a]};s.status&&(e.status=s.status),s.updatedAt&&(e.updatedAt=s.updatedAt),s.completedAt&&(e.completedAt=s.completedAt),s.duration&&(e.duration=s.duration),s.error&&(e.error=s.error),this.tasks=[...this.tasks.slice(0,a),e,...this.tasks.slice(a+1)],console.log("[TaskListStore] タスクを更新:",e)}}async fetchTaskDetails(t){try{const r=await fetch(`http://localhost:5000/api/tasks/${t}`,{headers:{"Content-Type":"application/json"}});if(r.ok){const s=await r.json();if(!this.tasks.some(e=>e.taskId===t)){const e={...s,id:s.id||s.taskId};this.tasks=[e,...this.tasks],console.log("[TaskListStore] 新しいタスクを追加:",e)}}}catch(r){console.error("[TaskListStore] タスク詳細の取得に失敗:",r)}}}const mt=new le;var ie=u("<!> ツリー表示",1),de=u("<!> 新しいタスク",1),ce=u('<div class="space-y-6"><div class="flex justify-between items-center"><div><h2 class="text-3xl font-bold tracking-tight">タスク一覧</h2> <p class="text-muted-foreground">実行中のタスクを管理</p></div> <div class="flex gap-2"><!> <!></div></div> <!> <!></div>');function Ae(i,t){A(t,!0),It(()=>{const d=Ut();mt.initialize(t.data.tasks||[],d)}),xt(()=>{}),Tt(()=>{mt.cleanup()});function r(d){window.location.href=`/tasks/${d}`}function s(){window.location.href="/tasks/new"}function a(d){window.location.href=`/tasks?page=${d}`}var e=ce(),o=g(e),l=h(g(o),2),_=g(l);ct(_,{variant:"outline",onclick:()=>window.location.href="/tasks/tree",children:(d,p)=>{var b=ie(),y=v(b);Bt(y,{class:"mr-2 h-4 w-4"}),k(),n(d,b)},$$slots:{default:!0}});var N=h(_,2);ct(N,{onclick:s,children:(d,p)=>{var b=de(),y=v(b);Nt(y,{class:"mr-2 h-4 w-4"}),k(),n(d,b)},$$slots:{default:!0}}),m(l),m(o);var z=h(o,2);re(z,{get tasks(){return mt.tasks},onTaskClick:r});var $=h(z,2);{let d=lt(()=>t.data.pagination?.page||1),p=lt(()=>t.data.pagination?.totalPages||1);ne($,{get currentPage(){return B(d)},get totalPages(){return B(p)},onPageChange:a})}m(e),n(i,e),L()}export{Ae as component,Ce as universal};
