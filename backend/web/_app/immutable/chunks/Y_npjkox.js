import{T as A,U as E,g as l,h as s,i as h,j as m,J as C,V as i}from"./DsgVtOPg.js";import{A as $,g as N}from"./vycYFVnX.js";class D{#e=l(!1);get connected(){return s(this.#e)}set connected(e){h(this.#e,e,!0)}#t=l(!1);get connecting(){return s(this.#t)}set connecting(e){h(this.#t,e,!0)}#s=l(!1);get authenticated(){return s(this.#s)}set authenticated(e){h(this.#s,e,!0)}#n=l(null);get error(){return s(this.#n)}set error(e){h(this.#n,e,!0)}#a=l(m([]));get messages(){return s(this.#a)}set messages(e){h(this.#a,e,!0)}#r=l(m(new Map));get taskMessages(){return s(this.#r)}set taskMessages(e){h(this.#r,e,!0)}#o=l(m(new Set));get subscriptions(){return s(this.#o)}set subscriptions(e){h(this.#o,e,!0)}ws=null;url;reconnectTimer;heartbeatTimer;reconnectAttempts=0;get isReady(){return this.connected&&this.authenticated}get latestMessage(){return this.messages[this.messages.length-1]}constructor(e){this.url=e||$.websocket}connect(){if(typeof window>"u"||typeof WebSocket>"u"){console.warn("[WebSocket] ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŽ¥ç¶šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");return}if(this.connected||this.connecting||this.ws){console.log("[WebSocket] æ—¢ã«æŽ¥ç¶šä¸­ã¾ãŸã¯æŽ¥ç¶šæ¸ˆã¿",{connected:this.connected,connecting:this.connecting,hasWs:!!this.ws});return}this.connecting=!0,this.error=null;try{console.log("[WebSocket] æŽ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™:",this.url),this.ws=new window.WebSocket(this.url),console.log("[WebSocket] WebSocketä½œæˆå®Œäº†",{readyState:this.ws.readyState,url:this.ws.url}),this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onerror=e=>this.handleError(e),this.ws.onclose=e=>this.handleClose(e)}catch(e){console.error("[WebSocket] æŽ¥ç¶šã‚¨ãƒ©ãƒ¼:",e),this.connecting=!1,this.error=e instanceof Error?e:new Error("æŽ¥ç¶šã‚¨ãƒ©ãƒ¼")}}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0),this.stopHeartbeat(),this.ws&&(this.ws.close(1e3,"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹åˆ‡æ–­"),this.ws=null),this.connected=!1,this.connecting=!1,this.authenticated=!1,this.subscriptions.clear()}send(e){if(!this.connected||!this.ws){console.error("WebSocketæœªæŽ¥ç¶š");return}this.ws.send(JSON.stringify(e))}authenticate(){if(typeof window>"u"){console.warn("[WebSocket] ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");return}const e=N();if(console.log("[WebSocket] èªè¨¼ã‚’é–‹å§‹",{hasApiKey:!!e}),!e){console.warn("[WebSocket] APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");const r="hoge";console.log("[WebSocket] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAPIã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™");const c={type:"auth",payload:{apiKey:r}};this.send(c);return}const n={type:"auth",payload:{apiKey:e}};console.log("[WebSocket] èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡",{type:n.type}),this.send(n)}subscribe(e){this.subscriptions.has(e)||(this.subscriptions.add(e),this.connected&&this.send({type:"subscribe",payload:{taskId:e}}))}unsubscribe(e){this.subscriptions.has(e)&&(this.subscriptions.delete(e),this.connected&&this.send({type:"unsubscribe",payload:{taskId:e}}))}getTaskMessages(e){return this.taskMessages.get(e)||[]}clearTaskMessages(e){const n=new Map(this.taskMessages);n.delete(e),this.taskMessages=n}handleOpen(){console.log("[WebSocket] æŽ¥ç¶šæˆåŠŸ"),this.connected=!0,this.connecting=!1,this.reconnectAttempts=0,this.authenticate(),this.startHeartbeat(),this.subscriptions.forEach(e=>{this.send({type:"subscribe",payload:{taskId:e}})})}handleMessage(e){try{const n=JSON.parse(e.data),r=this.normalizeMessage(n);if(this.messages=[...this.messages,r],r.taskId){const c=this.taskMessages.get(r.taskId)||[];this.taskMessages=new Map(this.taskMessages).set(r.taskId,[...c,r])}console.log("[WebSocket] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:",r.type,r),r.type==="auth:success"&&(this.authenticated=!0,console.log("[WebSocket] èªè¨¼æˆåŠŸ")),r.type==="auth:error"&&(this.authenticated=!1,console.error("[WebSocket] èªè¨¼å¤±æ•—:",r.error)),r.type}catch(n){console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æžã‚¨ãƒ©ãƒ¼:",n)}}handleError(e){console.error("WebSocketã‚¨ãƒ©ãƒ¼:",e),this.error=new Error("WebSocketæŽ¥ç¶šã‚¨ãƒ©ãƒ¼")}handleClose(e){console.log("WebSocketåˆ‡æ–­:",e.code,e.reason),this.connected=!1,this.connecting=!1,this.authenticated=!1,this.ws=null,this.stopHeartbeat(),e.code!==1e3&&e.code!==1001&&this.scheduleReconnect()}scheduleReconnect(){if(this.reconnectTimer)return;if(this.reconnectAttempts>=10){this.error=new Error("å†æŽ¥ç¶šã®æœ€å¤§è©¦è¡Œå›žæ•°ã«é”ã—ã¾ã—ãŸ");return}this.reconnectAttempts++;const e=Math.min(5e3*Math.pow(2,this.reconnectAttempts-1),3e4);console.log(`${e}mså¾Œã«å†æŽ¥ç¶šã‚’è©¦ã¿ã¾ã™ï¼ˆ${this.reconnectAttempts}/10ï¼‰`),this.reconnectTimer=window.setTimeout(()=>{this.reconnectTimer=void 0,this.ws=null,this.connect()},e)}startHeartbeat(){this.heartbeatTimer=window.setInterval(()=>{this.connected&&this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping",payload:{}})},3e4)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0)}normalizeMessage(e){if(e.payload){const{type:n,payload:r}=e,{taskId:c,timestamp:f,...b}=r||{};return{type:n,taskId:c,data:b,timestamp:f||new Date().toISOString()}}else return{...e,timestamp:e.timestamp||new Date().toISOString()}}}const S=Symbol("websocket");function R(a){A(S,a)}function M(){const a=E(S);if(!a)throw new Error("WebSocketã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");return a}function _(a){return new D(a)}function P(a){const e=M();C(()=>(e.subscribe(a),()=>{e.unsubscribe(a)}));const n=i(()=>e.getTaskMessages(a)),r=i(()=>s(n).filter(t=>["task:log","task:tool:start","task:tool:end","task:claude:response","task:todo_update"].includes(t.type)).map(t=>{switch(t.type){case"task:log":return t.data?.log||"";case"task:tool:start":return`ðŸ› ï¸ [${t.data?.tool}] é–‹å§‹${t.data?.input?`: ${JSON.stringify(t.data.input).slice(0,100)}...`:""}`;case"task:tool:end":return`âœ… [${t.data?.tool}] ${t.data?.success?"æˆåŠŸ":"å¤±æ•—"}${t.data?.duration?` (${t.data.duration}ms)`:""}`;case"task:claude:response":return`ðŸ¤– Claude: ${t.data?.text||""}`;case"task:todo_update":return t.data?.todos?`ðŸ“ TODOæ›´æ–°: ${t.data.todos.map(o=>`${o.content} [${o.status}]`).join(", ")}`:"ðŸ“ TODOæ›´æ–°";default:return JSON.stringify(t.data)}})),c=i(()=>s(n).filter(t=>t.type==="task:tool:start"||t.type==="task:tool:end").map(t=>({type:t.type,tool:t.data?.tool||"",args:t.data?.input,duration:t.data?.duration,success:t.data?.success,error:t.data?.error,timestamp:t.timestamp||new Date().toISOString()}))),f=i(()=>s(n).filter(t=>t.type==="task:claude:response").map(t=>({response:t.data?.text||"",turnNumber:t.data?.turnNumber,maxTurns:t.data?.maxTurns,timestamp:t.timestamp||new Date().toISOString()}))),b=i(()=>(()=>{const t=s(n).filter(g=>g.type==="task:statistics");if(t.length===0)return null;const o=t[t.length-1];return o.data?.statistics||o.data||null})()),W=i(()=>s(n).filter(t=>t.type==="task:todo_update").map(t=>t.data?.todos&&Array.isArray(t.data.todos)?t.data.todos.map(o=>({id:o.id,content:o.content||"",status:o.status||"",priority:o.priority||"medium",timestamp:t.timestamp||new Date().toISOString()})):[]).flat()),T=i(()=>(()=>{const t=s(n).filter(y=>y.type==="task:progress"),o=s(n).filter(y=>y.type==="task:claude:response"),g=o[o.length-1],w=g?.data?.turnNumber||0,k=g?.data?.maxTurns||0,p=t[t.length-1],d=p?.data?.progress?.phase||p?.data?.phase,x=p?.data?.progress?.message||p?.data?.message||"";let u=0;return d==="setup"?u=10:d==="planning"?u=20:d==="execution"?k>0?u=20+Math.min(60,w/k*60):u=50:d==="cleanup"?u=90:d==="complete"&&(u=100),{percent:u,message:x,turn:w,maxTurns:k,phase:d}})()),O=i(()=>(()=>{const t=s(n).filter(o=>["task:completed","task:failed","task:cancelled","task:update"].includes(o.type));return t.length===0?null:t[t.length-1]})());return{get connected(){return e.connected},get authenticated(){return e.authenticated},get messages(){return s(n)},get logs(){return s(r)},get toolExecutions(){return s(c)},get claudeResponses(){return s(f)},get statistics(){return s(b)},get todoUpdates(){return s(W)},get progress(){return s(T)},get statusChange(){return s(O)},clearMessages:()=>e.clearTaskMessages(a)}}function H(){const a=M();return{get connected(){return a.connected},get connecting(){return a.connecting},get authenticated(){return a.authenticated},get error(){return a.error},get isReady(){return a.isReady},connect:()=>a.connect(),disconnect:()=>a.disconnect()}}export{H as a,_ as c,R as s,P as u};
