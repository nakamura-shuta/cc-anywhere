# API型定義整合性改善計画

## 概要

フロントエンドとバックエンド間のAPI型定義の不一致を解消するための改善計画。

## 現状の問題点

### 1. タスク一覧API
- **バックエンド**: `{ tasks: [], total, limit, offset }`
- **フロントエンド**: `{ data: [], pagination: { page, limit, total, totalPages } }`
- **影響**: タスク一覧ページが正しく表示されない

### 2. TaskResponseオブジェクト
- プロパティ名の不一致（taskId vs id）
- バックエンド固有のプロパティが多数存在
- フロントエンドが期待するcontextプロパティが存在しない

### 3. エラーレスポンス
- バックエンド: `{ error: { message, statusCode, code } }`
- フロントエンド: `{ status, statusText, data }`

## 改善方針

### Phase 1: 即座の修正（完了）
1. ✅ タスク一覧ページの修正
   - taskStoreへの依存を削除
   - シンプルなデータ表示に変更

### Phase 2: サービス層での変換（進行中）
1. ✅ taskService.list()でのレスポンス変換
2. □ 他のサービスメソッドでの変換追加

### Phase 3: 型定義の統一（計画中）
1. □ 共通型定義パッケージの作成
2. □ OpenAPIスキーマの導入
3. □ 自動型生成の実装

## 実装状況

### 完了した修正

#### 1. タスク一覧ページ（/routes/tasks/+page.svelte）
- taskStoreへの依存を削除
- data.tasksを直接参照するように変更
- ページネーションの表示を修正

#### 2. タスクサービス（/lib/services/task.service.ts）
- list()メソッドでバックエンドレスポンスを変換
- offset/limitからpage/totalPagesへの変換ロジック追加

### 今後の作業

#### 1. 他のAPIエンドポイントの修正
- [ ] タスク詳細API
- [ ] タスクログAPI
- [ ] バッチタスクAPI
- [ ] セッションAPI

#### 2. エラーハンドリングの統一
- [ ] ApiErrorクラスの拡張
- [ ] バックエンドエラーフォーマットへの対応

#### 3. 型安全性の向上
- [ ] ランタイム型検証の追加（zod等）
- [ ] APIレスポンスの型ガード実装

## 推奨事項

### 短期的対策
1. 各サービスメソッドに変換ロジックを追加
2. 型定義を現実のAPIレスポンスに合わせて更新

### 長期的対策
1. バックエンドとフロントエンドで共通の型定義を使用
2. OpenAPIスキーマからの自動生成
3. GraphQLへの移行検討

## テスト方針

1. 各APIエンドポイントの統合テスト追加
2. モックデータを実際のAPIレスポンスに合わせて更新
3. 型の不一致を検出する自動テスト実装